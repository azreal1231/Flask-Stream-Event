<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Creating Real-Time Charts with Flask</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
</head>
<body ng-app="myApp" ng-controller="customersCtrl">
<div class="container mt-4">
    <div id="chart">
    </div>
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container mt-4">
    <div class="table-responsive" style="height: 30rem;">
        <table class="table table-sm" style="height: 300px;">
            <thead>
                <tr ng-click="print_data()" id="table_header">
                    <td>TIME</td>
                    <td>VALUE</td>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="x in names track by $index">
                    <td>{[ x.time ]}</td>
                    <td>{[ x.value ]}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!--suppress JSUnresolvedLibraryURL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>

</body>
</html>
<script>
var app = angular.module('myApp', []);
app.controller('customersCtrl', function($scope, $http) {

    var options = {
        chart: {
            height: 350,
            type: 'bar',
        },
        dataLabels: {
            enabled: false
        },
        series: [],
        title: {
            text: 'Ajax Example',
        },
        noData: {
            text: 'Loading...'
        }
        }

    var chart = new ApexCharts(
    document.querySelector("#chart"),
    options
    );

    chart.render();
    chart_data = []

    const apex_source = new EventSource("/chart-data");
    apex_source.onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log(data)
            tmp = {
                x: data.time,
                y: data.value
            }

            chart_data.push(tmp)

            chart.updateSeries([{
                name: 'Sales',
                data: chart_data
            }])
    }

    // var url = 'http://my-json-server.typicode.com/apexcharts/apexcharts.js/yearly';

    //     $.getJSON(url, function(response) {
    //     chart.updateSeries([{
    //         name: 'Sales',
    //         data: chart_data
    //     }])
    //     });
    
    $scope.names = [{'time': 'time', 'value': 'value'}]
    
    function update_names(_obj){
        // console.log(_obj)
        $scope.names.unshift(_obj);
        len = $scope.names.length
        if(len > 20){$scope.names = $scope.names.splice(0, 20)}
        document.getElementById("table_header").click();
    }

    $(document).ready(function () {
            const config = {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: "Random Dataset",
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: [],
                        fill: false,
                    }],
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: 'Creating Real-Time Charts with Flask'
                    },
                    tooltips: {
                        mode: 'index',
                        intersect: false,
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    },
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Time'
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Value'
                            }
                        }]
                    }
                }
            };
    
            // const context = document.getElementById('canvas').getContext('2d');
    
            // const lineChart = new Chart(context, config);
    
            // const chart_source = new EventSource("/chart-data");

            const table_source = new EventSource("/table-data");
    
            // chart_source.onmessage = function (event) {
            //     const data = JSON.parse(event.data);
            //     if (config.data.labels.length === 20) {
            //         config.data.labels.shift();
            //         config.data.datasets[0].data.shift();
            //     }
            //     config.data.labels.push(data.time);
            //     config.data.datasets[0].data.push(data.value);
            //     lineChart.update();
            // }

            table_source.onmessage = function (event) {
                const data = JSON.parse(event.data);
                // console.log(data)
                update_names(data);
                // console.log($scope.names)
                // if (config.data.labels.length === 20) {
                //     config.data.labels.shift();
                //     config.data.datasets[0].data.shift();
                // }
                // config.data.labels.push(data.time);
                // config.data.datasets[0].data.push(data.value);
                // lineChart.update();
            }
        });

    $scope.print_data = function(){
        // console.log($scope.names)
    }
    
        // $http.get("customers.php")
        // .then(function (response) {$scope.names = response.data.records;});
});
</script>
<script>
    app.config(function($interpolateProvider) {
        $interpolateProvider.startSymbol('{[');
        $interpolateProvider.endSymbol(']}');
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>